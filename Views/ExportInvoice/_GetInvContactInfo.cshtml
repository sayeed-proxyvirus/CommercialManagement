@model List<CommercialManagement.Models.ViewModels.ExportLCViewModel>

@{
    var totalPcs = Model?.Sum(x => x.TotalPcs ?? 0) ?? 0;
    var totalPrice = Model?.Sum(x => (x.TotalPcs ?? 0) * (x.TotalPrice ?? 0)) ?? 0;
}

<div class="card shadow-sm border-0 mb-0">
    <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table"></i> LC Contact Details</h5>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="openAddContactModal()">
                <i class="bi bi-plus-circle"></i> New Contact
            </button>
            <button type="button" class="btn-close" onclick="closeInvContactInfo()"></button>
        </div>
        
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0" id="invContactTable">
                <thead class="table-light">
                    <tr>
                        <th class="px-3" style="width: 200px;">Order Name</th>
                        <th class="text-end" style="width: 150px;">Shipped Qnty</th>
                        <th class="text-end" style="width: 150px;">Unit Price</th>
                        <th class="text-end" style="width: 150px;">Total</th>
                    </tr>
                </thead>
                <tbody id="invContactTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr data-contactid="@item.ContactId" data-contactno="@item.ContactNo">
                                <td class="px-3 fw-medium">@(item.ContactNo ?? "-")</td>
                                <td class="text-end">@((item.TotalPcs ?? 0).ToString("N0"))</td>
                                <td class="text-end">@((item.TotalPrice ?? 0).ToString("N4"))</td>
                                <td class="text-end fw-bold">@(((item.TotalPcs ?? 0) * (item.TotalPrice ?? 0)).ToString("N2"))</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                <p class="mb-0">No contact details found</p>
                            </td>
                        </tr>
                    }
                </tbody>
                @if (Model != null && Model.Any())
                {
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td class="px-3 text-end">
                                <strong>Total:</strong>
                            </td>
                            <td class="text-end">
                                <strong>Quantity:</strong> <span id="totalPcs">@totalPcs.ToString("N0")</span>
                            </td>
                            <td class="text-end"></td>
                            <td class="text-end text-success">
                                <strong>Total value:</strong> $ <span id="totalPrice">@totalPrice.ToString("N2")</span>
                            </td>
                        </tr>
                    </tfoot>
                }
            </table>
        </div>
    </div>
    @if (Model != null && Model.Any())
    {
        <div class="card-footer bg-white border-top">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Showing <span id="pageInfo">1 to @Math.Min(15, Model.Count) of @Model.Count</span> entries
                </small>
                <div id="paginationContainer"></div>
            </div>
        </div>
    }
</div>

<script>
    $(document).ready(function() {
        initializeInvContactPagination();
    });

    // Pagination variables
    let invContactCurrentPage = 1;
    const invContactRowsPerPage = 15;
    let invContactAllRows = [];

    function initializeInvContactPagination() {
        invContactAllRows = $('#invContactTableBody tr').toArray();
        if (invContactAllRows.length > 0 && !$('#invContactTableBody tr td[colspan]').length) {
            displayInvContactPage();
        }
    }

    function displayInvContactPage() {
        const totalPages = Math.ceil(invContactAllRows.length / invContactRowsPerPage);
        const start = (invContactCurrentPage - 1) * invContactRowsPerPage;
        const end = start + invContactRowsPerPage;

        // Show/hide rows
        invContactAllRows.forEach((row, index) => {
            $(row).toggle(index >= start && index < end);
        });

        // Update footer and pagination
        updateInvContactFooter(start, end);
        renderInvContactPagination(totalPages);
        updateVisibleInvContactTotals();
    }

    function updateInvContactFooter(start, end) {
        const total = invContactAllRows.length;
        const displayStart = total > 0 ? start + 1 : 0;
        const displayEnd = Math.min(end, total);
        $('#pageInfo').text(`${displayStart} to ${displayEnd} of ${total}`);
    }

    function renderInvContactPagination(totalPages) {
        if (totalPages <= 1) {
            $('#paginationContainer').empty();
            return;
        }

        const createPageItem = (page, text, disabled = false, active = false) => {
            const disabledClass = disabled ? 'disabled' : '';
            const activeClass = active ? 'active' : '';
            const onclick = !disabled && !active ? `onclick="changeInvContactPage(${page}); return false;"` : '';
            return `<li class="page-item ${disabledClass} ${activeClass}">
                        <a class="page-link" href="#" ${onclick}>${text}</a>
                    </li>`;
        };

        let html = '<nav><ul class="pagination pagination-sm mb-0">';

        // Previous button
        html += createPageItem(invContactCurrentPage - 1, '<i class="bi bi-chevron-left"></i>', invContactCurrentPage === 1);

        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, invContactCurrentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);

        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        if (startPage > 1) {
            html += createPageItem(1, '1');
            if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }

        for (let i = startPage; i <= endPage; i++) {
            html += createPageItem(i, i, false, i === invContactCurrentPage);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            html += createPageItem(totalPages, totalPages);
        }

        // Next button
        html += createPageItem(invContactCurrentPage + 1, '<i class="bi bi-chevron-right"></i>', invContactCurrentPage === totalPages);

        html += '</ul></nav>';
        $('#paginationContainer').html(html);
    }

    function changeInvContactPage(page) {
        const totalPages = Math.ceil(invContactAllRows.length / invContactRowsPerPage);
        if (page < 1 || page > totalPages) return;
        invContactCurrentPage = page;
        displayInvContactPage();
    }

    function updateVisibleInvContactTotals() {
        let totalPcs = 0;
        let totalAmount = 0;

        $('#invContactTableBody tr:visible').each(function() {
            const pcs = parseInt($(this).find('td:eq(1)').text().replace(/,/g, '')) || 0;
            const amount = parseFloat($(this).find('td:eq(3)').text().replace(/,/g, '')) || 0;
            totalPcs += pcs;
            totalAmount += amount;
        });

        $('#totalPcs').text(totalPcs.toLocaleString());
        $('#totalPrice').text(totalAmount.toFixed(2));
    }

    function closeInvContactInfo() {
        $('#invContactContainer').slideUp(400, function() {
            $(this).empty();
        });
    }
</script>

<style>
    #invContactTable {
        font-size: 0.9rem;
    }

        #invContactTable thead th {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        #invContactTable tbody tr {
            transition: background-color 0.2s;
        }

            #invContactTable tbody tr:hover {
                background-color: #f1f3f5;
            }

        #invContactTable tfoot {
            font-size: 1rem;
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
        }

            #invContactTable tfoot td {
                padding: 1rem 0.75rem;
            }

    .pagination {
        margin: 0;
    }

    .page-link {
        color: #1b6ec2;
        border-color: #dee2e6;
        padding: 0.375rem 0.75rem;
    }

        .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }

    .page-item.active .page-link {
        background-color: #1b6ec2;
        border-color: #1b6ec2;
    }

    .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
    }

    /* Empty state styling */
    .table tbody td[colspan] i {
        color: #adb5bd;
    }
</style>
