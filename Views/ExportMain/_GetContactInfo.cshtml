@model List<CommercialManagement.Models.ViewModels.ExportLCViewModel>

@{
    var totalPcs = Model?.Sum(x => x.TotalPcs ?? 0) ?? 0;
    var totalPrice = Model?.Sum(x => x.TotalPrice ?? 0) ?? 0;
}

<div class="card shadow-sm border-0 mb-0">
    <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table"></i> Contact Details</h5>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="openAddContactModal()">
                <i class="bi bi-plus-circle"></i> New Contact
            </button>
            <button type="button" class="btn-close" onclick="closeContactDetails()"></button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0" id="contactTable">
                <thead class="table-light">
                    <tr>
                        <th class="px-3" style="width: 120px;">Contact NO</th>
                        <th>Style Name</th>
                        <th class="text-end" style="width: 130px;">Qnty in PCS</th>
                        <th class="text-end" style="width: 130px;">Unit Price $</th>
                        <th class="text-end" style="width: 150px;">Total</th>
                        <th class="text-center" style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="contactTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr data-contactid="@item.ContactId" data-contactno="@item.ContactNo" data-explcno="@item.ExpLCNo">
                                <td class="px-3 fw-semibold">@(item.ContactNo ?? "-")</td>
                                <td>@(item.StyleDesc ?? "Not found")</td>
                                <td class="text-end">@((item.TotalPcs ?? 0).ToString("N0"))</td>
                                <td class="text-end">@((item.TotalPrice ?? 0).ToString("N4"))</td>
                                <td class="text-end fw-bold">@(((item.TotalPcs ?? 0) * (item.TotalPrice ?? 0)).ToString("N2"))</td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-warning"
                                            onclick="editContact(@item.ContactId, '@item.ExpLCNo', '@item.ContactNo', @(item.TotalPcs ?? 0), @(item.TotalPrice ?? 0))"
                                            title="Edit Contact">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No contact details found
                            </td>
                        </tr>
                    }
                </tbody>
                @if (Model != null && Model.Any())
                {
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td colspan="2" class="px-3 text-end">
                                <strong>Total:</strong>
                            </td>
                            <td class="text-end">
                                <span id="totalPcs">@totalPcs.ToString("N0")</span> Pcs
                            </td>
                            <td class="text-end"></td>
                            <td class="text-end text-success">
                                $ <span id="totalPrice">@totalPrice.ToString("N2")</span>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                }
            </table>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="card-footer bg-white border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Showing <span id="pageInfo">1 to @Math.Min(10, Model.Count) of @Model.Count</span> entries
                    </small>
                    <div id="paginationContainer"></div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="contactModalLabel">
                    <i class="bi bi-file-earmark-plus"></i> <span id="contactModalTitle">Add New Contact</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="contactForm">
                <div class="modal-body">
                    <!--- ContactID -->
                    <input type="hidden" id="contactId" name="ContactId" value="0" />

                    <!-- Export LC No -->
                    <div class="mb-3">
                        <label for="contactExpLCNo" class="form-label fw-semibold">
                            <i class="bi bi-file-text"></i> Export LC No: <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="contactExpLCNo" name="ExpLCNo" readonly
                               style="background-color: #e9ecef;">
                        <div class="invalid-feedback">LC Number is required</div>
                    </div>

                    <!-- Contact No -->
                    <div class="mb-3">
                        <label for="contactContactNo" class="form-label fw-semibold">
                            <i class="bi bi-hash"></i> Contact No: <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="contactContactNo" name="ContactNo"
                               placeholder="Enter Contact Number" required maxlength="50">
                        <div class="invalid-feedback">Please enter Contact Number</div>
                    </div>

                    <!-- Total Pcs -->
                    <div class="mb-3">
                        <label for="contactTotalPcs" class="form-label fw-semibold">
                            <i class="bi bi-box"></i> Total Pcs: <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="contactTotalPcs" name="TotalPcs"
                               placeholder="0" min="1" required>
                        <div class="invalid-feedback">Please enter Total Pcs (must be greater than 0)</div>
                    </div>

                    <!-- Total Price -->
                    <div class="mb-3">
                        <label for="contactTotalPrice" class="form-label fw-semibold">
                            <i class="bi bi-currency-dollar"></i> Unit Price ($): <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="contactTotalPrice" name="TotalPrice"
                               placeholder="0.00" step="0.0001" min="0.0001" required>
                        <div class="invalid-feedback">Please enter Unit Price (must be greater than 0)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSaveContact">
                        <i class="bi bi-save"></i> <span id="btnSaveContactText">Save Contact</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        initializeContactPagination();

        $('#contactForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateContactForm()) return false;

            const contactId = $('#contactId').val();
            contactId && contactId !== '0' ? updateContact() : addContact();
        });
    });

    // Pagination variables
    let contactCurrentPage = 1;
    const contactRowsPerPage = 15;
    let contactAllRows = [];

    function initializeContactPagination() {
        contactAllRows = $('#contactTableBody tr').toArray();
        if (contactAllRows.length > 0) {
            displayContactPage();
        }
    }

    function displayContactPage() {
        const totalPages = Math.ceil(contactAllRows.length / contactRowsPerPage);
        const start = (contactCurrentPage - 1) * contactRowsPerPage;
        const end = start + contactRowsPerPage;

        // Show/hide rows
        contactAllRows.forEach((row, index) => {
            $(row).toggle(index >= start && index < end);
        });

        // Update footer and pagination
        updateContactFooter(start, end);
        renderContactPagination(totalPages);
        updateVisibleTotals();
    }

    function updateContactFooter(start, end) {
        const total = contactAllRows.length;
        const displayStart = total > 0 ? start + 1 : 0;
        const displayEnd = Math.min(end, total);
        $('#pageInfo').text(`${displayStart} to ${displayEnd} of ${total}`);
    }

    function renderContactPagination(totalPages) {
        if (totalPages <= 1) {
            $('#paginationContainer').empty();
            return;
        }

        const createPageItem = (page, text, disabled = false, active = false) => {
            const disabledClass = disabled ? 'disabled' : '';
            const activeClass = active ? 'active' : '';
            const onclick = !disabled && !active ? `onclick="changeContactPage(${page}); return false;"` : '';
            return `<li class="page-item ${disabledClass} ${activeClass}">
                        <a class="page-link" href="#" ${onclick}>${text}</a>
                    </li>`;
        };

        let html = '<nav><ul class="pagination pagination-sm mb-0">';

        // Previous button
        html += createPageItem(contactCurrentPage - 1, '<i class="bi bi-chevron-left"></i>', contactCurrentPage === 1);

        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, contactCurrentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);

        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        if (startPage > 1) {
            html += createPageItem(1, '1');
            if (startPage > 2) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }

        for (let i = startPage; i <= endPage; i++) {
            html += createPageItem(i, i, false, i === contactCurrentPage);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            html += createPageItem(totalPages, totalPages);
        }

        // Next button
        html += createPageItem(contactCurrentPage + 1, '<i class="bi bi-chevron-right"></i>', contactCurrentPage === totalPages);

        html += '</ul></nav>';
        $('#paginationContainer').html(html);
    }

    function changeContactPage(page) {
        const totalPages = Math.ceil(contactAllRows.length / contactRowsPerPage);
        if (page < 1 || page > totalPages) return;
        contactCurrentPage = page;
        displayContactPage();
    }

    function updateVisibleTotals() {
        let totalPcs = 0;
        let totalAmount = 0;

        $('#contactTableBody tr:visible').each(function() {
            const pcs = parseInt($(this).find('td:eq(2)').text().replace(/,/g, '')) || 0;
            const amount = parseFloat($(this).find('td:eq(4)').text().replace(/,/g, '')) || 0;
            totalPcs += pcs;
            totalAmount += amount;
        });

        $('#totalPcs').text(totalPcs.toLocaleString());
        $('#totalPrice').text(totalAmount.toFixed(2));
    }

    // Open Add Contact Modal
    function openAddContactModal() {
        const lcNo = $('#lcSearch').val();

        if (!lcNo) {
            showAlert('warning', 'Please select an Export LC first');
            return;
        }

        $('#contactForm')[0].reset();
        $('#contactId').val('0');
        $('#contactExpLCNo').val(lcNo);
        $('#contactContactNo').prop('readonly', false);

        $('#contactModalTitle').text('Add New Contact');
        $('#btnSaveContactText').text('Save Contact');

        $('#contactForm').removeClass('was-validated');
        $('.form-control').removeClass('is-invalid');

        $('#contactModal').modal('show');
    }

    // Edit Contact
    function editContact(contactId, expLCNo, contactNo, totalPcs, totalPrice) {
        $('#contactId').val(contactId);
        $('#contactExpLCNo').val(expLCNo);
        $('#contactContactNo').val(contactNo).prop('readonly', true);
        $('#contactTotalPcs').val(totalPcs);
        $('#contactTotalPrice').val(totalPrice);

        $('#contactModalTitle').text('Edit Contact');
        $('#btnSaveContactText').text('Update Contact');

        $('#contactForm').removeClass('was-validated');
        $('.form-control').removeClass('is-invalid');

        $('#contactModal').modal('show');
    }

    // Validate Contact Form
    function validateContactForm() {
        let isValid = true;
        $('.form-control').removeClass('is-invalid');

        const validations = [
            { field: '#contactExpLCNo', check: val => !val.trim() },
            { field: '#contactContactNo', check: val => !val.trim() },
            { field: '#contactTotalPcs', check: val => !val || parseInt(val) < 1 },
            { field: '#contactTotalPrice', check: val => !val || parseFloat(val) <= 0 }
        ];

        validations.forEach(v => {
            if (v.check($(v.field).val())) {
                $(v.field).addClass('is-invalid');
                isValid = false;
            }
        });

        if (!isValid) showAlert('warning', 'Please fill in all required fields correctly');
        return isValid;
    }

    // Add Contact
    function addContact() {
        const formData = {
            ExpLCNo: $('#contactExpLCNo').val().trim(),
            ContactNo: $('#contactContactNo').val().trim(),
            TotalPcs: parseInt($('#contactTotalPcs').val()),
            TotalPrice: parseFloat($('#contactTotalPrice').val())
        };

        $('#btnSaveContact').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

        $.ajax({
            url: '@Url.Action("AddContacts", "ExportMain")',
            type: 'POST',
            data: formData,
            headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    $('#contactModal').modal('hide');

                    // Immediately reload contact details
                    const lcName = $('#lcSearch').val();
                    if (lcName) {
                        loadContactDetails(lcName);
                    }
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                showAlert('danger', 'An error occurred. Please try again.');
            },
            complete: function() {
                $('#btnSaveContact').prop('disabled', false)
                    .html('<i class="bi bi-save"></i> Save Contact');
            }
        });
    }

    // Update Contact
    function updateContact() {
        const formData = {
            ContactId: parseInt($('#contactId').val()),
            ExpLCNo: $('#contactExpLCNo').val().trim(),
            ContactNo: $('#contactContactNo').val().trim(),
            TotalPcs: parseInt($('#contactTotalPcs').val()),
            TotalPrice: parseFloat($('#contactTotalPrice').val())
        };

        $('#btnSaveContact').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm me-2"></span>Updating...');

        $.ajax({
            url: '@Url.Action("UpdateContacts", "ExportMain")',
            type: 'POST',
            data: formData,
            headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    $('#contactModal').modal('hide');

                    // Immediately reload contact details
                    const lcName = $('#lcSearch').val();
                    if (lcName) {
                        loadContactDetails(lcName);
                    }
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                showAlert('danger', 'An error occurred. Please try again.');
            },
            complete: function() {
                $('#btnSaveContact').prop('disabled', false)
                    .html('<i class="bi bi-save"></i> Update Contact');
            }
        });
    }
</script>

<style>
        #contactTable {
            font-size: 0.9rem;
        }

            #contactTable thead th {
                font-size: 0.75rem;
                text-transform: uppercase;
                font-weight: 600;
                color: #495057;
                background-color: #f8f9fa;
                border-bottom: 2px solid #dee2e6;
            }

            #contactTable tbody tr {
                transition: background-color 0.2s;
            }

                #contactTable tbody tr:hover {
                    background-color: #f1f3f5;
                }

            #contactTable tfoot {
                font-size: 1rem;
                background-color: #f8f9fa;
                border-top: 2px solid #dee2e6;
            }

                #contactTable tfoot td {
                    padding: 1rem 0.75rem;
                }

        .pagination {
            margin: 0;
        }

        .page-link {
            color: #1b6ec2;
            border-color: #dee2e6;
            padding: 0.375rem 0.75rem;
        }

            .page-link:hover {
                background-color: #e9ecef;
                border-color: #dee2e6;
            }

        .page-item.active .page-link {
            background-color: #1b6ec2;
            border-color: #1b6ec2;
        }

        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }

        .btn-outline-warning:hover {
            color: #000;
        }

        .invalid-feedback {
            display: none;
            font-size: 0.875rem;
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

            .form-control.is-invalid ~ .invalid-feedback {
                display: block;
            }
    </style>
