@model List<CommercialManagement.Models.ViewModels.ExportLCViewModel>

@{
    var totalPcs = Model?.Sum(x => x.TotalPcs ?? 0) ?? 0;
    var totalPrice = Model?.Sum(x => x.TotalPrice ?? 0) ?? 0;
}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table"></i> Contact Details</h5>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="openAddContactModal()">
                <i class="bi bi-plus-circle"></i> New Contact
            </button>
            <button type="button" class="btn-close" onclick="closeContactDetails()"></button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0" id="contactTable">
                <thead class="table-light">
                    <tr>
                        <th class="px-3" style="width: 120px;">Contact NO</th>
                        <th>Style Name</th>
                        <th class="text-end" style="width: 130px;">Qnty in PCS</th>
                        <th class="text-end" style="width: 130px;">Unit Price $</th>
                        <th class="text-end" style="width: 150px;">Total</th>
                        <th class="text-center" style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="contactTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr data-contactid="@item.ContactId" data-contactno="@item.ContactNo" data-explcno="@item.ExpLCNo">
                                <td class="px-3 fw-semibold">@(item.ContactNo ?? "-")</td>
                                <td>@(item.StyleDesc ?? "Not found")</td>
                                <td class="text-end">@((item.TotalPcs ?? 0).ToString("N0"))</td>
                                <td class="text-end">@((item.TotalPrice ?? 0).ToString("N4"))</td>
                                <td class="text-end fw-bold">@(((item.TotalPcs ?? 0) * (item.TotalPrice ?? 0)).ToString("N2"))</td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-warning"
                                            onclick="editContact(@item.ContactId, '@item.ExpLCNo', '@item.ContactNo', @(item.TotalPcs ?? 0), @(item.TotalPrice ?? 0))"
                                            title="Edit Contact">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No contact details found
                            </td>
                        </tr>
                    }
                </tbody>
                @if (Model != null && Model.Any())
                {
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td colspan="2" class="px-3 text-end">
                                <strong>Total:</strong>
                            </td>
                            <td class="text-end">
                                <span id="totalPcs">@totalPcs.ToString("N0")</span> Pcs
                            </td>
                            <td class="text-end"></td>
                            <td class="text-end text-success">
                                $ <span id="totalPrice">@totalPrice.ToString("N2")</span>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                }
            </table>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="card-footer bg-white border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Showing
                    </small>
                </div>
            </div>
        }
    </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="contactModalLabel">
                    <i class="bi bi-file-earmark-plus"></i> <span id="contactModalTitle">Add New Contact</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="contactForm">
                <div class="modal-body">
                    <!-- ContactID -->
                    <input type="hidden" id="contactId" name="ContactId" value="0" />

                    <!-- Export LC No -->
                    <div class="mb-3">
                        <label for="contactExpLCNo" class="form-label fw-semibold">
                            <i class="bi bi-file-text"></i> Export LC No: <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="contactExpLCNo" name="ExpLCNo" readonly
                               style="background-color: #e9ecef;">
                        <div class="invalid-feedback">LC Number is required</div>
                    </div>

                    <!-- Contact No -->
                    <div class="mb-3">
                        <label for="contactContactNo" class="form-label fw-semibold">
                            <i class="bi bi-hash"></i> Contact No: <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="contactContactNo" name="ContactNo"
                               placeholder="Enter Contact Number" required maxlength="50">
                        <div class="invalid-feedback">Please enter Contact Number</div>
                    </div>

                    <!-- Total Pcs -->
                    <div class="mb-3">
                        <label for="contactTotalPcs" class="form-label fw-semibold">
                            <i class="bi bi-box"></i> Total Pcs: <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="contactTotalPcs" name="TotalPcs"
                               placeholder="0" min="1" required>
                        <div class="invalid-feedback">Please enter Total Pcs (must be greater than 0)</div>
                    </div>

                    <!-- Total Price -->
                    <div class="mb-3">
                        <label for="contactTotalPrice" class="form-label fw-semibold">
                            <i class="bi bi-currency-dollar"></i> Unit Price ($): <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="contactTotalPrice" name="TotalPrice"
                               placeholder="0.00" step="0.0001" min="0.0001" required>
                        <div class="invalid-feedback">Please enter Unit Price (must be greater than 0)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSaveContact">
                        <i class="bi bi-save"></i> <span id="btnSaveContactText">Save Contact</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- jQuery MUST be loaded first -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Then Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Then DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize DataTable with pagination
        $('#contactTable').DataTable({
            pageLength: 15,
            order: [[0, "asc"]],
            searching: false,
            lengthChange: false,
            info: true,
            paging: true,
            language: {
                emptyTable: "No contact details found"
            }
        });

        // Handle contact form submission
        $('#contactForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateContactForm()) return false;

            const contactId = $('#contactId').val();
            contactId && contactId !== '0' ? updateContact() : addContact();
        });
    });

    // Open Add Contact Modal
    function openAddContactModal() {
        const lcNo = $('#lcSearch').val();

        if (!lcNo) {
            showAlert('warning', 'Please select an Export LC first');
            return;
        }

        $('#contactForm')[0].reset();
        $('#contactId').val('0');
        $('#contactExpLCNo').val(lcNo);
        $('#contactContactNo').prop('readonly', false);

        $('#contactModalTitle').text('Add New Contact');
        $('#btnSaveContactText').text('Save Contact');

        $('#contactForm').removeClass('was-validated');
        $('.form-control').removeClass('is-invalid');

        $('#contactModal').modal('show');
    }

    // Edit Contact
    function editContact(contactId, expLCNo, contactNo, totalPcs, totalPrice) {
        $('#contactId').val(contactId);
        $('#contactExpLCNo').val(expLCNo);
        $('#contactContactNo').val(contactNo).prop('readonly', true);
        $('#contactTotalPcs').val(totalPcs);
        $('#contactTotalPrice').val(totalPrice);

        $('#contactModalTitle').text('Edit Contact');
        $('#btnSaveContactText').text('Update Contact');

        $('#contactForm').removeClass('was-validated');
        $('.form-control').removeClass('is-invalid');

        $('#contactModal').modal('show');
    }

    // Validate Contact Form
    function validateContactForm() {
        let isValid = true;
        $('.form-control').removeClass('is-invalid');

        const validations = [
            { field: '#contactExpLCNo', check: val => !val.trim() },
            { field: '#contactContactNo', check: val => !val.trim() },
            { field: '#contactTotalPcs', check: val => !val || parseInt(val) < 1 },
            { field: '#contactTotalPrice', check: val => !val || parseFloat(val) <= 0 }
        ];

        validations.forEach(v => {
            if (v.check($(v.field).val())) {
                $(v.field).addClass('is-invalid');
                isValid = false;
            }
        });

        if (!isValid) showAlert('warning', 'Please fill in all required fields correctly');
        return isValid;
    }

    // Add Contact
    function addContact() {
        const formData = {
            ExpLCNo: $('#contactExpLCNo').val().trim(),
            ContactNo: $('#contactContactNo').val().trim(),
            TotalPcs: parseInt($('#contactTotalPcs').val()),
            TotalPrice: parseFloat($('#contactTotalPrice').val())
        };
        console.log(formData);

        $('#btnSaveContact').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

        $.ajax({
            url: '@Url.Action("AddContacts", "ExportMain")',
            type: 'POST',
            data: formData,
            headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    $('#contactModal').modal('hide');

                    const lcName = $('#lcSearch').val();
                    if (lcName) {
                        setTimeout(() => loadContactDetails(lcName), 1000);
                    }
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                showAlert('danger', 'An error occurred while adding the contact. Please try again.');
                console.error('Error:', xhr);
            },
            complete: function() {
                $('#btnSaveContact').prop('disabled', false)
                    .html('<i class="bi bi-save"></i> Save Contact');
            }
        });
    }

    // Update Contact
    function updateContact() {
        const formData = {
            ContactId: parseInt($('#contactId').val()),
            ExpLCNo: $('#contactExpLCNo').val().trim(),
            ContactNo: $('#contactContactNo').val().trim(),
            TotalPcs: parseInt($('#contactTotalPcs').val()),
            TotalPrice: parseFloat($('#contactTotalPrice').val())
        };

        $('#btnSaveContact').prop('disabled', true)
            .html('<span class="spinner-border spinner-border-sm me-2"></span>Updating...');

        $.ajax({
            url: '@Url.Action("UpdateContacts", "ExportMain")',
            type: 'POST',
            data: formData,
            headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    $('#contactModal').modal('hide');

                    const lcName = $('#lcSearch').val();
                    if (lcName) {
                        setTimeout(() => loadContactDetails(lcName), 1000);
                    }
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr) {
                showAlert('danger', 'An error occurred while updating the contact. Please try again.');
                console.error('Error:', xhr);
            },
            complete: function() {
                $('#btnSaveContact').prop('disabled', false)
                    .html('<i class="bi bi-save"></i> Update Contact');
            }
        });
    }
</script>

<style>
        #contactTable {
            font-size: 0.9rem;
        }

            #contactTable thead th {
                font-size: 0.75rem;
                text-transform: uppercase;
                font-weight: 600;
                color: #495057;
                background-color: #f8f9fa;
                border-bottom: 2px solid #dee2e6;
            }

            #contactTable tbody tr {
                transition: background-color 0.2s;
            }

                #contactTable tbody tr:hover {
                    background-color: #f1f3f5;
                }

            #contactTable tfoot {
                font-size: 1rem;
                background-color: #f8f9fa;
                border-top: 2px solid #dee2e6;
            }

                #contactTable tfoot td {
                    padding: 1rem 0.75rem;
                }

        .pagination {
            margin: 0;
        }

        .page-link {
            color: #1b6ec2;
            border-color: #dee2e6;
            padding: 0.375rem 0.75rem;
        }

            .page-link:hover {
                background-color: #e9ecef;
                border-color: #dee2e6;
            }

        .page-item.active .page-link {
            background-color: #1b6ec2;
            border-color: #1b6ec2;
        }

        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }

        .btn-outline-warning:hover {
            color: #000;
        }

        .invalid-feedback {
            display: none;
            font-size: 0.875rem;
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

            .form-control.is-invalid ~ .invalid-feedback {
                display: block;
            }
    </style>
