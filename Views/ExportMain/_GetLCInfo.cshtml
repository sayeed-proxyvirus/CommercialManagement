@model List<CommercialManagement.Models.ViewModels.ExportMainViewModel>

@{
    var data = Model?.FirstOrDefault();
}

<div class="card shadow-sm border-0 mb-4" id="lcInfoCard" data-expid="@(data?.ExpID ?? 0)">
    <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Export LC Details</h5>
        <button type="button" class="btn-close" onclick="closeLCInfo()"></button>
    </div>
    <div class="card-body">
        <form id="lcInfoForm">
            <div class="row g-3">
                <!-- Left Column -->
                <div class="col-md-6">
                    <!-- Export LC No -->
                    <div class="mb-3">
                        <label for="exportLCNo" class="form-label fw-semibold">EXPORT L/C NO:</label>
                        <input type="text" class="form-control" id="exportLCNo"
                               value="@(data?.MainExpName ?? "")" readonly style="background-color: #e9ecef;">
                    </div>

                    <!-- L/C Date -->
                    <div class="mb-3">
                        <label for="lcDate" class="form-label fw-semibold">L/C DATE:</label>
                        <input type="date" class="form-control" id="lcDate"
                               value="@(data?.LCDate?.ToString("yyyy-MM-dd") ?? "")" readonly style="background-color: #e9ecef;">
                    </div>

                    <!-- Total Value -->
                    <div class="mb-3">
                        <label for="totalValue" class="form-label fw-semibold">TOTAL VALUE $</label>
                        <input type="number" class="form-control fw-bold text-primary" id="totalValue"
                               value="@(data?.TotalValue ?? 0)" readonly step="0.01"
                               style="background-color: #007bff; color: white !important; font-size: 1.1rem;">
                    </div>

                    <!-- Reference # -->
                    <div class="mb-3">
                        <label for="referenceNo" class="form-label fw-semibold">Reference #</label>
                        <input type="text" class="form-control" id="referenceNo"
                               value="@(data?.MainExpRem ?? "")" readonly style="background-color: #e9ecef;">
                    </div>
                    
                    <!-- Hidden fields to store additional data -->
                    <input type="hidden" id="mainExpTaka" value="@(data?.MainExpTaka ?? 0)">
                    <input type="hidden" id="expQuantity" value="@(data?.ExpQuanity ?? 0)">
                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                    <!-- LC Applicant -->
                    <div class="mb-3">
                        <label for="lcApplicant" class="form-label fw-semibold">LC APPLICANT</label>
                        <select class="form-select" id="lcApplicant" disabled>
                            <option value="">-- Select Applicant --</option>
                            @if (ViewBag.ListApplicant != null)
                            {
                                foreach (var applicant in ViewBag.ListApplicant)
                                {
                                    <option value="@applicant.ApplicantID"
                                            selected="@(applicant.ApplicantID == data?.ApplicantID)">
                                        @applicant.ApplicantName
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Beneficiary -->
                    <div class="mb-3">
                        <label for="beneficiary" class="form-label fw-semibold">BENEFICIARY</label>
                        <select class="form-select" id="beneficiary" disabled>
                            <option value="">-- Select Beneficiary --</option>
                            @if (ViewBag.ListBeneficiary != null)
                            {
                                foreach (var beneficiary in ViewBag.ListBeneficiary)
                                {
                                    <option value="@beneficiary.BenID"
                                            selected="@(beneficiary.BenID == data?.BenID)">
                                        @beneficiary.BenName
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Notify -->
                    <div class="mb-3">
                        <label for="notify" class="form-label fw-semibold">NOTIFY</label>
                        <select class="form-select" id="notify" disabled>
                            <option value="">-- Select Notify Party --</option>
                            @if (ViewBag.ListNotify != null)
                            {
                                foreach (var notify in ViewBag.ListNotify)
                                {
                                    <option value="@notify.PartyID"
                                            selected="@(notify.PartyID == data?.PartyID)">
                                        @notify.PartyName
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Ship Date -->
                    <div class="mb-3">
                        <label for="shipDate" class="form-label fw-semibold">SHIP DATE:</label>
                        <input type="date" class="form-control" id="shipDate"
                               value="@(data?.ShipDate?.ToString("yyyy-MM-dd") ?? "")" readonly style="background-color: #e9ecef;">
                    </div>

                    <!-- Destination -->
                    <div class="mb-3">
                        <label for="destination" class="form-label fw-semibold">DESTINATION</label>
                        <input type="text" class="form-control" id="destination"
                               value="@(data?.Destination ?? "")" readonly style="background-color: #e9ecef;">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" onclick="closeLCInfo()">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editLC()">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button type="button" class="btn btn-success" id="btnSaveLC" onclick="saveLC()" style="display: none;">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function editLC() {
        console.log('Edit mode activated');
        
        // Enable all form fields for editing except the LC No
        $('#lcInfoForm').find('input:not(#exportLCNo), select').prop('disabled', false)
            .css('background-color', '#ffffff');
        
        $('#lcInfoForm').find('input[readonly]:not(#exportLCNo)').prop('readonly', false)
            .css('background-color', '#ffffff');
        
        // Show Save button, hide Edit button
        $('#btnSaveLC').show();
        $('button[onclick="editLC()"]').hide();

        showAlert('info', 'Edit mode enabled. Modify the fields and click Save.');
    }

    function saveLC() {
        console.log('Save LC clicked');
        
        // Get ExpID from the card's data attribute
        const expID = $('#lcInfoCard').data('expid');
        
        console.log('ExpID:', expID);
        
        if (!expID || expID === 0) {
            showAlert('danger', 'Error: Export LC ID not found');
            return;
        }
        
        // Collect form data from the actual input fields
        const formData = {
            ExpID: parseInt(expID),
            MainExpName: $('#exportLCNo').val().trim(),
            ReceiveDate: $('#lcDate').val(),
            ExpDate: $('#shipDate').val() || null,
            Dollars: parseFloat($('#totalValue').val()) || 0,
            MainExpRem: $('#referenceNo').val().trim(),
            MainExpTaka: parseFloat($('#mainExpTaka').val()) || null,
            ExpQuanity: parseFloat($('#expQuantity').val()) || null,
            ApplicantID: parseInt($('#lcApplicant').val()) || null,
            BenID: parseInt($('#beneficiary').val()) || null,
            PartyID: parseInt($('#notify').val()) || null,
            Destination: $('#destination').val().trim() || null
        };
        
        console.log('Form Data being sent:', formData);
        
        // Validate required fields
        if (!formData.MainExpName) {
            showAlert('warning', 'LC Number is required');
            return;
        }
        
        if (!formData.ReceiveDate) {
            showAlert('warning', 'LC Date is required');
            return;
        }
        
        if (!formData.Dollars || formData.Dollars <= 0) {
            showAlert('warning', 'Total Value must be greater than 0');
            return;
        }
        
        if (!formData.ApplicantID) {
            showAlert('warning', 'Please select an Applicant');
            return;
        }
        
        if (!formData.BenID) {
            showAlert('warning', 'Please select a Beneficiary');
            return;
        }
        
        if (!formData.PartyID) {
            showAlert('warning', 'Please select a Notify Party');
            return;
        }

        // Disable save button
        $('#btnSaveLC').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

        $.ajax({
            url: '@Url.Action("UpdateLCs", "ExportMain")',
            type: 'POST',
            data: formData,
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                console.log('Server Response:', response);
                
                if (response.success) {
                    showAlert('success', response.message);
                    
                    // Disable fields again
                    $('#lcInfoForm').find('input, select').prop('disabled', true)
                        .css('background-color', '#e9ecef');
                    $('#lcInfoForm').find('input').prop('readonly', true);
                    
                    // Hide Save button, show Edit button
                    $('#btnSaveLC').hide();
                    $('button[onclick="editLC()"]').show();
                    
                    // Reload the LC info after a short delay
                    const lcName = formData.MainExpName;
                    setTimeout(function() {
                        if (typeof loadLCInfo === 'function') {
                            loadLCInfo(lcName);
                        }
                        // Update the dropdown selection
                        $('#lcSearch').val(lcName);
                    }, 1000);
                    
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
                console.error('Response:', xhr.responseText);
                showAlert('danger', 'An error occurred while updating the LC. Please try again.');
            },
            complete: function() {
                $('#btnSaveLC').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
            }
        });
    }
</script>

<style>
    .form-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #000;
        margin-bottom: 0.25rem;
    }

    .form-control:disabled,
    .form-select:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    #totalValue {
        background-color: #007bff;
        color: #000000;
    }

        #totalValue:not([readonly]) {
            background-color: #007bff !important;
            color: #000000 !important;
        }
</style>